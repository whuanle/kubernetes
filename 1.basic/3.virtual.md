# 1.1 讲透虚拟化

本章内容讲讲解虚拟化。



## 理论基础

### 计算机层次结构

从语言角度，一台由软硬件组成的通用计算机系统可以看作是按功能划分的多层机器级组成的层次结构。

如果从语言角度来看，计算机系统的层次结构可用下图所示。

![hierarchical](H:\文章\K8S基础教程\1.basic\.images\hierarchical.jpg)

【图来源：《计算机组成原理》天勤考研 1.2.5 计算机系统的层次结构】



我们平时使用的笔记本、安卓手机、平板电脑、Linux 服务器等，虽然不同机器的系统和部分硬件差异很大，但是其系统结构是一致的。



下面讲解一下不同层次的主要特点。

计算机的最底层是硬联逻辑级，由门电路，触发器等逻辑电路组成。

![m1](H:\文章\K8S基础教程\1.basic\.images\m0.jpg)



微程序是使用微指令编写的，一个微程序即一个机器指令，一般直接由硬件执行。例如一个加法指令，由多个逻辑元件构成一个加法器。如下图是一个 8 位全加器。

![m1](H:\文章\K8S基础教程\1.basic\.images\m1.png)

传统机器语言机器级是处理器的指令集所在，我们熟知的 X86、ARM、MIPS、RISC-V 等指令集，便是在这个层次。程序员使用指令集中的指令编写的程序，由低一层微程序解释。



操作系统机器层是从操作系统基本功能来看的，操作系统需要负责管理计算机中的软硬件资源，如内存、设备、文件等，它是软硬件的交互界面。常用的操作系统有 Windows、Linux、Unix 等。这个层次使用的语言是机器语言，即 0、1 组成的二进制代码，能够由计算机直接识别和执行。



汇编语言机器层顾名思义是汇编语言所在的位置，汇编语言与处理器有关，相同类型的处理器使用的汇编语言集是一致的。汇编语言需要被汇编语言程序变换为等效的二进制代码目标程序。由于计算机中的资源被操作系统所管理，因此汇编语言需要在操作系统的控制下进行。



到了高级语言机器层，便是我们使用的 C、C++ 等编程语言，高级语言是与人类思维相接近的语言。



### 软硬件实现等效

<p>
    <div style="color: rgb(23, 23, 23); font-family: &quot;Segoe UI&quot;, SegoeUI, &quot;Segoe WP&quot;, &quot;Helvetica Neue&quot;, Helvetica, Tahoma, Arial, sans-serif; background-color: rgb(255, 241, 204);border-radius: 10px;padding:20px;">
	计算机的某些功能即可以由硬件实现，也可以由软件来实现。即软件和硬件在功能意义上是等效的。
</div>
</p>




一个功能使用硬件来实现还是使用软件来实现？

硬件实现：速度快、成本高；灵活性差、占用内存少。

软件实现：速度低、复制费用低；灵活性好、占用内存多。

虚拟化技术是将原本 硬件实现的功能，使用软件来实现，它们在性能、价格、实现的难易程度是不同的。





### 模拟和仿真

将一个软件在不加修改或很少修改的情况下，放到另一个环境中运行，称为软件移植。



软件的移植技术有以下几种：

* 统一高级语言，要求在所有机器上统一使用一种高级语言，例如 C 语言。从现在来看，C 语言确实可以在 Windows、Linux 等操作系统中运行，是目前最广泛使用的高级编程语言，但是 C 语言也要根据操作系统的不同，使用不同的库文件。

* 采用系列机，不同型号的机器之间使用同一种汇编语言。使用系列机方法，要求不同机器的系统结构相同或接近，不同机器之间硬件差异较大，使用同一种汇编语言不现实。

* 模拟和仿真。在一种机器的系统结构上实现另一种机器的系统结构，从指令系统上看，就是要在一种机器上实现另一种机器的指令系统。



模拟和仿真的区别是，模拟是使用机器语言程序解释的，而仿真是由微程序解释的。我们在大学中学习到的单片机便是仿真硬件。而我们平时使用的 VMWare 等虚拟机则是属于模拟。



## 虚拟化

<p>
    <div style="color: rgb(23, 23, 23); font-family: &quot;Segoe UI&quot;, SegoeUI, &quot;Segoe WP&quot;, &quot;Helvetica Neue&quot;, Helvetica, Tahoma, Arial, sans-serif; background-color: rgb(255, 241, 204);border-radius: 10px;padding:20px;">
	虚拟化（技术）或虚拟技术是一种资源管理技术，将计算机的各种实体资源（CPU、内存、磁盘空间、网络适配器等），予以抽象、转换后呈现出来并可供分割、组合为一个或多个计算机配置环境。
</div>
</p>



### 不同层次的虚拟化

我们应该在很多书籍、文章中，了解到虚拟机跟 Docker 的比较，了解到 Docker 的优点，通过 Docker 打包镜像后可以随时在别的地方运行而不需要担心机器的兼容问题。

![virstual](H:\文章\K8S基础教程\1.basic\.images\virstual.jpg)

在指令集级别虚拟化中，QEMU 可以实现在 X64 机器上模拟 ARM32/64、龙芯、MIPS 等处理器。



虚拟化程度在于使用硬件实现与软件实现的比例。



### 传统虚拟化部署方式

硬件抽象级别虚拟化。

特点是 虚拟化程度高

![traditional_kvm ](H:\文章\K8S基础教程\1.basic\.images\traditional_kvm .jpg)

1，虚拟机之间通过虚拟化技术隔离互不影响
2，物理机上可部署多台虚拟机，提升资源利用率
3，应用资源分配、扩容通过虚拟管理器直接可配置
4，支持快照、虚拟机克隆多种技术，快速部署、容灾减灾

传统虚拟化部署方式-缺点

1， 资源占用高	需要额外的操作系统镜像，需要占用GB级别的内存以及数十GB存储空间。
 2，启动速度慢	虚拟机启动需要先启动虚拟机内操作系统，然后才能启动应用。
 3，性能影响高应用 => 虚拟机操作系统=> 物理机操作系统=> 硬件资源



## Docker 虚拟化

### Docker

Docker是一个开放源代码软件项目，自动化进行应用程序容器化部署，借此在Linux操作系统上，提供一个额外的软件抽象层，以及操作系统层虚拟化的自动管理机制。  
-From wiki

![docker_logo](H:\文章\K8S基础教程\1.basic\.images\docker_logo.jpg)



### 虚拟机和 Docker 的差异

| ** **    | **虚拟机**                       | **Docker 容器**                              |
| -------- | -------------------------------- | -------------------------------------------- |
| 隔离程度 | 硬件级进程隔离                   | 操作系统级进程隔离                           |
| 系统     | 每个虚拟机都有一个单独的操作系统 | 每个容器可以共享操作系统（共享操作系统内核） |
| 启动时间 | 需要几分钟                       | 几秒                                         |
| 体积大小 | 虚拟机镜像需要几GB               | 容器是轻量级的（KB/MB）                      |
| 启动镜像 | 虚拟机镜像比较难找到             | 预建的 docker 容器很容易获得                 |
| 迁移     | 虚拟机可以轻松迁移到新主机       | 容器被销毁并重新创建而不是移动               |
| 创建速度 | 创建 VM 需要相对较长的时间       | 可以在几秒钟内创建容器                       |
| 资源使用 | 更多资源使用                     | 更少的资源使用                               |

![virstual_location](H:\文章\K8S基础教程\1.basic\.images\virstual_location.jpg)